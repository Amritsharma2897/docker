name: Playwright Tests
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      matrix:
        container: [container1, container2, container3]
    services:
      automation:
        image: test305/automation:latest
        ports:
          - 8080:8080
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Build Docker image
        run: docker build -t automation .
      - name: Divide test cases equally among containers
        run: |
          test_files=$(find . -name "*.spec.ts")
          total_files=$(echo "$test_files" | wc -l)
          files_per_container=$((total_files / 3))
          for i in $(seq 1 3); do
            start=$((i * files_per_container - files_per_container + 1))
            end=$((i * files_per_container))
            if [ $i -eq 3 ]; then
              end=$total_files
            fi
            echo "Container $i will run test cases from $start to $end"
            echo "$test_files" | sed -n "${start},${end}p" > "container$i.txt"
          done
      - name: Run Playwright tests in containers
        run: |
          for container in ${{ matrix.container }}; do
            docker run --rm -it --network host -v $PWD:/app -w /app $container npx playwright test $(cat container${{ matrix.container }}.txt)
          done
      - name: Upload Playwright report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30


# name: Playwright Tests

# on:
#   push:
#     branches: [main, master]
#   pull_request:
#     branches: [main, master]

# jobs:
#   test:
#     timeout-minutes: 60
#     runs-on: ubuntu-latest
#     services:
#       automation:
#         image: test305/automation:latest
#         ports:
#           - 8080:8080
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3
      
#       - name: Setup Node.js
#         uses: actions/setup-node@v3
#         with:
#           node-version: 18
          
#       - name: Install dependencies
#         run: npm ci
      
#       - name: Install Playwright Browsers
#         run: npx playwright install --with-deps
      
#       - name: Build Docker image
#         run: docker build -t automation .
      
#       - name: Run Playwright tests
#         run: npx playwright test
      
#       - name: Upload Playwright report
#         uses: actions/upload-artifact@v3
#         if: always()
#         with:
#           name: playwright-report
#           path: playwright-report/
#           retention-days: 30


# name: Playwright Tests

# on:
#   push:
#     branches: [main, master]
#   pull_request:
#     branches: [main, master]

# jobs:
#   test:
#     runs-on: ubuntu-latest

#     services:
#       docker:
#         image: test305/automation:latest
#         ports:
#           - 8080:8080

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Pull Docker image
#         run: |
#           docker pull test305/automation:latest

#       - name: Set up Node.js
#         uses: actions/setup-node@v3
#         with:
#           node-version: 18

#       - name: Install dependencies
#         run: npm ci

#       - name: Install Playwright Browsers
#         run: npx playwright install --with-deps

#       - name: Run Playwright tests in Docker container
#         run: |
#           docker run -d \
#             -v ${{ github.workspace }}/playwright-report:/app/playwright-report \
#             -e ENV_VARIABLE=value \
#             --name test-container \
#             test305/automation:latest \
#             npx playwright test

#       - name: Wait for Test Container to Complete
#         run: sleep 10

#       - name: Cleanup
#         run: docker rm -f test-container

#       - name: Upload Test Report
#         uses: actions/upload-artifact@v3
#         with:
#           name: playwright-report
#           path: C:\Users\amrit.sharma\Documents\git_test\docker\playwright-report
#           retention-days: 30

# name: Playwright Tests

# on:
#   push:
#     branches: [main, master]
#   pull_request:
#     branches: [main, master]

# jobs:
#   test:
#     runs-on: ubuntu-latest

#     services:
#       docker:
#         image: test305/automation:latest
#         ports:
#           - 8080:8080

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Pull Docker image
#         run: |
#           docker pull test305/automation:latest

#       - name: Set up Node.js
#         uses: actions/setup-node@v3
#         with:
#           node-version: 18

#       - name: Install dependencies
#         run: npm ci

#       - name: Install Playwright Browsers
#         run: npx playwright install --with-deps

#       - name: Run Playwright tests in Docker container
#         run: |
#           docker run -d \
#             -v ${{ github.workspace }}/playwright-report:/app/playwright-report \
#             -e ENV_VARIABLE=value \
#             --name test-container \
#             test305/automation:latest \
#             npx playwright test

#       - name: Wait for Test Container to Complete
#         run: sleep 10

#       - name: Print Docker Container Logs
#         run: docker logs test-container

#       - name: Verify Playwright Reports Inside Docker Container
#         run: docker exec test-container ls -R /app/playwright-report/


#       - name: List contents of the directory
#         run: ls -R ${{ github.workspace }}/playwright-report/

#       - name: Cleanup
#         run: docker rm -f test-container

#       - name: Upload Test Report
#         uses: actions/upload-artifact@v3
#         with:
#           name: playwright-report
#           path: ${{ github.workspace }}/playwright-report/
#           retention-days: 30

# name: Playwright Tests

# on:
#   push:
#     branches: [main, master]
#   pull_request:
#     branches: [main, master]

# jobs:
#   test:
#     runs-on: ubuntu-latest

#     services:
#       docker:
#         image: test305/automation:latest
#         ports:
#           - 8080:8080

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Pull Docker image
#         run: docker pull test305/automation:latest

#       - name: Set up Node.js
#         uses: actions/setup-node@v3
#         with:
#           node-version: 18

#       - name: Install dependencies
#         run: npm ci

#       - name: Install Playwright Browsers
#         run: npx playwright install --with-deps

#       - name: Run Playwright tests in Docker container
#         run: |
#           docker run -d \
#             -v $(pwd)/playwright-report:/docker/playwright-report \
#             -e ENV_VARIABLE=value \
#             --name test-container \
#             test305/automation:latest \
#             npx playwright test

#       - name: List contents of playwright-report directory
#         run: docker exec test-container ls -R /app/playwright-report/     

#       - name: Wait for Test Container to Complete
#         run: docker wait test-container

#       - name: Upload Test Report
#         uses: actions/upload-artifact@v3
#         with:
#           name: playwright-report
#           path: /app/playwright-report/
#           retention-days: 30